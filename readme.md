# О Docker-образе

Образ базируется на официальном дистрибутиве, доступном по адресу
`http://asiou.coikko.ru/static/update_version/www<VERSION>.zip`.
Из архива распаковывается только часть файлов, необходимых для работы,
так как он содержит большое количество "мусора", работоспособность
проверяется только на одной организации (ЯГК).

Из файлов, касающихся базы данных, оставляются только файлы обновления
начиная с 2018-го года, поэтому данный образ не подходит для первоначального
развёртывания БД.

Также образ содержит ряд дополнений, которые позволяют ускорить или
исправить рабоут АСИОУ.


# Дополнения (патчи)

- Убрано использование `pysvn`, так как этого пакета нет для установки
  (да и применение его для обновления совсем неоправданно, очень станный
  функционал).
  
- Добавлен модуль кэширования запросов к БД `johnny-cache`, который
  настроен на кэширование в рамках одного запроса пользователя.
  Необходимость использования обоснована тем, что часто выполняется куча
  абсолютно одинаковых запросов, результаты которых не кэшируются
  на стороне кода, что очень странно.

- Исправлен код, выполняющий экспорт в Контингент. Данный функционал
  содержит много проблем, которые разработчики не могут заделать, но
  пока исправлена критическая часть, которая позволяет функционалу
  как минимум отработать на стандартных найстройках БД.


# Использование

Установка и настройка Docker находится за пределами данного мануала,
предполагается, что он уже есть и работает. Существует Docker под
платформу Windows, но всё же рекомендуется работать на Linux-системе.

Данный образ запускает Nginx и Django. Nginx обрабатывает HTTP-запросы
на порту 8080, статические файлы отдаёт с диска, остальные запросы
проксирует через FastCGI на Django. Ожидается, что база данных будет
запущена за пределами образа.

## Пример запуска БД

Можно использовать уже существующую инсталляцию MySQL или, например,
также запустить в контейнере. При использовании существующей БД для
дальнейших шагов потребуются данные из файла `db.ini`.

Развернуть контейнер с MySQL можно следующим путём:

- Сгенерировать надёжный пароль для пользователя `root`, далее вместо него
  будет использоваться `PaSwOrD`.
- Сгенерировать надёжный пароль для пользователя `asiou`, далее `AsiouPassword`.
- Запустить контейнер с MySQL следующей командой:
  ```
  docker run -d --name mysql -e MYSQL_ROOT_PASSWORD=PaSwOrD -v <DATADIR>/mysql:/var/lib/mysql -p 3306:3306 mysql:5.7
  ```
  Где `<DATADIR>` - директория на хосте для хранения БД, чтобы при перезапуске
  данные не потерялись.

- Далее нужно создать базу данных и пользоватя для АСИОУ:
  ```
  docker exec -it mysql mysql -u root -pPaSwOrD -e "CREATE DATABASE asiou; GRANT ALL PRIVILEGES ON asiou.* TO 'asiou'@'%' IDENTIFIED BY 'AsiouPassword';"
  ```

Выше приведён очень простой и небезопасный, пример запуска, так как порт
базы дынных будет доступен снаружи, рекомендуется использовать приватные
сети для связки двух контейнров (см. документацию Docker).


## Пример запуска контейнера с АСИОУ

Из параметров минимально нужно передать хост и пароль к базе данных, в данном
случае получится команда:
```
docker run --rm -it -e DATABASE_HOST=172.17.0.1 -e DATABASE_PASSWORD=AsiouPassword -p8080:8080 yarsttec/asiou
```
где `172.17.0.1` адрес сервера БД.
Список возможных переменных окружения для настройки контейнера с АСИОУ см. ниже.


# Сборка образа

Для сборки образа рекомендуется воспользоваться файлом `build.sh` для Linux машин
и `build.ps1` (PowerShell) для сборки под Windows.


# Доступные переменные окружения запуска

- `ASIOU_OPTIONS`, base64-encoded содержимое файла `asiou/options.ini`.
   По умолчанию найстройки даны для использования в СПО.
- `DATABASE_HOST`, хост MySQL (по умолчанию `127.0.0.1`).
- `DATABASE_PORT`, порт MySQL (по умолчанию `3306`).
- `DATABASE_NAME`, имя базы данных (по умолчанию `asiou`).
- `DATABASE_USER`, имя пользователя MySQL (по умолчанию `asiou`).
- `DATABASE_PASSWORD`, пароль пользователя MySQL.
