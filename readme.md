# О Docker-образе

Образ базируется на официальном дистрибутиве, доступном по адресу
`http://asiou.coikko.ru/static/update_version/www<VERSION>.zip`.
Из архива распаковывается только часть файлов, необходимых для работы,
так как он содержит большое количество "мусора", работоспособность
проверяется только на одной организации (ЯГК).

Из файлов, касающихся базы данных, оставляются только файлы обновления
начиная с 2018-го года, поэтому данный образ не подходит для первоначального
развёртывания БД.

Также образ содержит ряд дополнений, которые позволяют ускорить или
исправить рабоут АСИОУ.


# Дополнения (патчи)

- Убрано использование `pysvn`, так как этого пакета нет для установки
  (да и применение его для обновления совсем неоправданно, очень станный
  функционал).
  
- Добавлен модуль кэширования запросов к БД `johnny-cache`, который
  настроен на кэширование в рамках одного запроса пользователя.
  Необходимость использования обоснована тем, что часто выполняется куча
  абсолютно одинаковых запросов, результаты которых не кэшируются
  на стороне кода, что очень странно.

- Исправлен код, выполняющий экспорт в Контингент. Данный функционал
  содержит много проблем, которые разработчики не могут заделать, но
  пока исправлена критическая часть, которая позволяет функционалу
  как минимум отработать на стандартных найстройках БД.


# Использование

Установка и настройка Docker находится за пределами данного мануала,
предполагается, что он уже есть и работает. Существует Docker под
платформу Windows, но всё же рекомендуется работать на Linux-системе.

Данный образ запускает Nginx и Django. Nginx обрабатывает HTTP-запросы
на порту 8080, статические файлы отдаёт с диска, остальные запросы
проксирует через FastCGI на Django. Ожидается, что база данных будет
запущена за пределами образа.

## Пример запуска БД

Можно использовать уже существующую инсталляцию MySQL или, например,
также запустить в контейнере. При использовании существующей БД для
дальнейших шагов потребуются данные из файла `db.ini`.

Развернуть контейнер с MySQL можно следующим путём:

- Сгенерировать надёжный пароль для пользователя `root`, далее вместо него
  будет использоваться `PaSwOrD`.
- Сгенерировать надёжный пароль для пользователя `asiou`, далее `AsiouPassword`.
- Запустить контейнер с MySQL следующей командой:
  ```
  docker run -d --name mysql --restart=unless-stopped \
    -e MYSQL_ROOT_PASSWORD=PaSwOrD \
    -v <DATADIR>/mysql:/var/lib/mysql \
    -p 3306:3306 mysql:5.7
  ```
  Где `<DATADIR>` - директория на хосте для хранения БД, чтобы при перезапуске
  данные не потерялись.

- Далее нужно создать базу данных и пользоватя для АСИОУ:
  ```
  docker exec -it mysql mysql -u root -pPaSwOrD \
    -e "CREATE DATABASE asiou; GRANT ALL PRIVILEGES ON asiou.* TO 'asiou'@'%' IDENTIFIED BY 'AsiouPassword';"
  ```

Выше приведён очень простой и небезопасный, пример запуска, так как порт
базы дынных будет доступен снаружи, рекомендуется использовать приватные
сети для связки двух контейнров (см. документацию Docker).


## Пример запуска контейнера с АСИОУ

Из параметров минимально нужно передать хост и пароль к базе данных, в данном
случае получится команда:
```
docker run -itd --name asiou --restart=unless-stopped \
    -e DATABASE_HOST=172.17.0.1 \
    -e DATABASE_PASSWORD=AsiouPassword \
    -p80:8080 yarsttec/asiou
```
где `172.17.0.1` адрес сервера БД.
Список возможных переменных окружения для настройки контейнера с АСИОУ см. ниже.


# Сборка образа

Для собственной сборки образа рекомендуется воспользоваться файлом `build.sh`
для Linux машин и `build.ps1` (PowerShell) для сборки под Windows.


# Доступные переменные окружения запуска

- `ASIOU_OPTIONS`, base64-encoded содержимое файла `asiou/options.ini`.
   По умолчанию найстройки даны для использования в СПО.
- `DATABASE_HOST`, хост MySQL (по умолчанию `127.0.0.1`).
- `DATABASE_PORT`, порт MySQL (по умолчанию `3306`).
- `DATABASE_NAME`, имя базы данных (по умолчанию `asiou`).
- `DATABASE_USER`, имя пользователя MySQL (по умолчанию `asiou`).
- `DATABASE_PASSWORD`, пароль пользователя MySQL.


# Обновление

Для проверки доступности новой версии образа можно выполнить команду:
```
docker pull yarsttec/asiou
```
Если появился текст `Downloaded newer image for`, значит была загружена
новая версия.
Теперь необходимо завершить текущий контейнер:
```
docker stop asiou && docker rm asiou
```
Затем запустить обновление БД (команда аналогична команде запуска):
```
docker run -it --rm \
    -e DATABASE_HOST=172.17.0.1 \
    -e DATABASE_PASSWORD=AsiouPassword \
    yarsttec/asiou update
```
и снова запустить рабочий контейнер на свежей версии образа.


# Работа с бэкапами

## Введение

В образе содержится ряд утилит позволяющих просто и безопасно создавать бэкапы
базы данных. Основной упор ставится на шифрование данных, для чего
используется пара открытого и закрытого ключа и алгоритм RSA.

Вы можете сгенерировать пару ключей самостоятельно или воспользоваться
командой из образа (RSA 4096 bits):
```
docker run -it --rm \
    -v <DATADIR>/asiou/backup:/srv/backup \
    yarsttec/asiou gen-backup-keys
```
После выполнения команды в директории `<DATADIR>/asiou/backup` появятся файлы:
- `asiou_backup_private_key.pem`, закрытый ключ, должен храниться в надёжном
  месте, потребуются для восстановления архива.
- `asiou_backup_public_key.pem`, открытый ключ, будет необходим при каждом
  создании бэкапа.

Открытый ключ можно оставить в данной директории и осуществлять её монтирование
при каждом запуске процесса бэкапа. Утилиты работы с бэкапами ожидают, что
будет подмонтирована директория `/srv/backup` с ключом и в которой окажется
результат выполнения.

Во время выполнения бэкапа будет создан одноразовый случайный ключ на 256 бит,
с помощью которого будет осуществлено надёжное шифрование данных дампа БД.
В данном случае используется симметричное шифрование (aes-256-cbc),
это означает, что расшифровка будет происходить тем же ключём и его нужно
надёжно защитить. Для чего будет использоваться предоставленный открытый ключ,
которым будет зашифрован одноразовый ключ. Исходный вариант случайного
ключа будет удалён. Восстановить одноразовый ключ можно будет только
с помощью закрытого ключа (что и происходит во время восстановления дампа).


## Создание бэкапа

Для создания бэкапа можно воспользоваться командой:
```
docker run -it --rm \
    -v <DATADIR>/asiou/backup:/srv/backup \
    -e DATABASE_HOST=172.17.0.1 \
    -e DATABASE_PASSWORD=AsiouPassword \
    yarsttec/asiou backup
```

В результате выполнения в папке `<DATADIR>/asiou/backup` создатся файл вида
`backup_asiou_db_20180630_151124.tar`, где `20180630` дата создания бэкапа,
а `151124` время.

Содержимое архива бэкапа выглядит так:
```
backup_asiou_db_20180630_151124.tar:
 - backup_asiou_db.key.enc     <- Зашифрованный одноразовый ключ
 - backup_asiou_db.sql.bz2.enc <- Дамп базы, сжатый и зашифрованный
 - backup_asiou_db.sha256      <- Контрольная сумма sha256 ключа и данных
 - backup_asiou_db.md5         <- Контрольная сумма md5 ключа и данных
```

После сжатия и шифрования дампа БД, происходит обратный процесс (расшифровка
и развёртывание архива) для проверки на ошибки.
Также создаются файлы с контрольными суммами sha256 и md5 для проверки
при дальнейшем развёртывании.

## Развёртывание бэкапа

Для развёртывания бэкапа процесс происходит аналогичным образом, но утилита
требует наличие приватного ключа в директории с данными, а также указание
имени файла при запуске.
```
docker run -it --rm \
    -v <DATADIR>/asiou/backup:/srv/backup \
    -e DATABASE_HOST=172.17.0.1 \
    -e DATABASE_PASSWORD=AsiouPassword \
    yarsttec/asiou restore backup_asiou_db_20180630_151124.tar
```

В процессе развёртывания все текущие данные будут полностью перезаписаны.


# Ошибки

Образ предоставляется как есть, автор не несёт ответственность за его работу
и какую-либо потерю данных, но делает всё возможное, что всё работало
стабильно. Если Вы нашли ошибку или желаете внести дополнение в образ -
раздел `Issues` окажется в самый раз. Любые ошибки, непосредственно
связанные с функционалом АСИОУ, направляйте на официальный форум -
http://forum.asiou.ru, автор образа никак не связан с авторами АСИОУ.
